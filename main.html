<!DOCTYPE html>
<html>

<head>
	<script src="https://aframe.io/releases/0.3.0/aframe.min.js"></script>
	<script src="https://greeny3ny.github.io/VRBaseball_altspace/dist/altspace.js"></script>
	
	<script>
      // n-skeleton-parent only works with root meshes at the moment. Since most model loaders use a root
      // container object, we need to collapse the model so that n-skeleton-parent can access the mesh directly.
         AFRAME.registerComponent('collapse-model', {
        init: function () {
            this.el.addEventListener('model-loaded', function () {
                this.el.object3DMap.mesh.updateMatrixWorld();
                var mesh;
                this.el.object3DMap.mesh.traverse(function (obj) {
                    if (!mesh && obj instanceof THREE.Mesh) {
                        mesh = obj;
                    }
                }.bind(this))
                if (mesh) {
                    this.el.sceneEl.object3D.updateMatrixWorld(true);
                    mesh.scale.copy(mesh.getWorldScale());
                    this.el.setObject3D('mesh', mesh);
                    // setObject3D emits this event in a-frame 0.4.0
                    this.el.emit('object3dset', {
                        type: 'mesh'
                    });
                }
            }.bind(this));
        }
    });
  </script>
	
</head>
	
<body>

<!-- set up the scene -->
<a-scene altspace="fullspace:true" sync-system='app: theater; author: greeny3ny'>
	
	<!-- assets -->
	<a-assets>
		<a-asset-item id="bat" src="https://greeny3ny.github.io/VRBaseball_altspace/models/baseballbat.dae"></a-asset-item>
		<img id="board1" src="https://greeny3ny.github.io/VRBaseball_altspace/images/board1.png">
	</a-assets>
	
	<a-mixin id="bat1" collada-model="#bat" collapse-model></a-mixin>
    <a-mixin id="parent-to-right-hand" position="-0.10 -0.04 -0.15" rotation="90 225 90" scale="0.3 0.36 0.3" n-skeleton-parent="part: hand; side: right;" sync sync-n-skeleton-parent></a-mixin> 
	<a-entity position="31 2.1 2" mixin="bat1" rotation="180 0 0" scale="0.3 0.36 0.3" instantiator="on: click;group:bat1; mixin: bat1 parent-to-right-hand"></a-entity>
	
	<!-- disabled while testing so i dont get sick of song -->
	<!--
	<a-entity id="tmootbPC" n-sound="src:https://greeny3ny.github.io/VRBaseball_altspace/audio/tmootb.ogg; volume: 0.25; loop: false; autoplay: true;" n-skeleton-parent="part: spine"></a-entity>
	<a-entity id="tmootbGEAR" n-sound="src:https://greeny3ny.github.io/VRBaseball_altspace/audio/tmootb.mp3; volume: 0.25; loop: false; autoplay: true;" n-skeleton-parent="part: spine"></a-entity>
	-->
	<a-entity class="scoreboard" scale="1 2 2" position="5 0 0">
		<a-entity position='90 15 0' rotation='0 -90 0' n-text='text: Craigs Baseball! ;'></a-entity>
		<a-entity position='90 14 0' rotation='0 -90 0' n-text='text: Red Team : 0 Runs ;'></a-entity>
		<a-entity position='90 13 0' rotation='0 -90 0' n-text='text: Blue Team : 0 Runs ;'></a-entity>
		<a-box position='92 14 0' color="black" scale="0.1 20 20"></a-box>
		<a-image src="#board1" position="91 15 0" rotation="0 90 0" scale="20 20"></a-image>
	</a-entity>
	<!-- ground -->
	<a-plane n-mesh-collider="type:environment; convex: false" position="0, 0, 0" width="500" height="500" color="#0FD" rotation="-90 0 0"></a-plane>
	
	<!-- baseball -->
	<a-entity position="38 3 0" n-spawner='res: interactables/basketball'></a-entity>
	
	<!-- baseball bat -->
	<a-entity n-mesh-collider="type:environment; convex: false" position="2 1 2" rotation="0 0 0" scale="0.1 0.16 0.1" collada-model="#bat"></a-entity>

	
	<!--<a-entity position="0 1 0" n-object='res: effects/fireworks'></a-entity>-->
	
		<!-- basic layout -->
		
		<!-- ramp -->
		<!-- 3.162 = sqrt(10) , as looking for hyp of 3 along and 1 up = right angled triangle -->
		<a-box n-mesh-collider="type:environment" color="blue" position="4, 1, 0" rotation="0 0 108.44" scale="0.0 3.162"></a-box>
		
		<!-- walls -->
			<a-box n-mesh-collider="type:environment" color="red" position="6.5, 1, 0" rotation="0 0 0" scale="2 1 1"></a-box>
			<a-box n-mesh-collider="type:environment" color="green" position="10.5, 1, 0" rotation="0 0 0" scale="6 1 1"></a-box>
			<a-box n-mesh-collider="type:environment" color="red" position="13.6, 1, 0" rotation="0 0 0" scale="0.2 1 1"></a-box>
			<a-box n-mesh-collider="type:environment" color="green" position="16.7, 1, 0" rotation="0 0 0" scale="6 1 1"></a-box>
			<a-box n-mesh-collider="type:environment" color="red" position="19.8, 1, 0" rotation="0 0 0" scale="0.2 1 1"></a-box>
		
		<!-- shift 10 -->
		
		<!-- field -->
		<a-box n-mesh-collider="type:environment" color="#1F4" position="48.9, 1, 0" rotation="0 0 0" scale="45 1 49"></a-box> <!-- baseplate -->
		<a-cylinder n-mesh-collider="type:environment" color="#1F4" height="1" radius="25" position="67 1 0"></a-cylinder> <!-- outfield -->
		<a-cylinder color="#c48f70" height="1" radius="14" position="45 1.002 0"></a-cylinder> <!-- infield -->
		
		<!-- used to make it look like actual baseball field -->
		<a-box color="#1F4" position="42 1 0" rotation="0 45 0" scale="13 1.01 13"></a-box> 
		<a-box color="#1F4" position="38.5 1 11" rotation="0 45 0" scale="4 1.03 22"></a-box>
		<a-box color="#1F4" position="38.5 1 -11" rotation="0 -45 0" scale="4 1.03 22"></a-box>
		
		<!-- diamond -->
			<a-box n-mesh-collider="type:hologram" color="white" position="32, 1.1, 0" rotation="0 0 0" scale="1 1 1"></a-box> <!-- home -->
			<a-cylinder n-mesh-collider="type:environment" color="#c48f70" height="1" radius="3.75" position="32 1.02 0"></a-cylinder> <!-- home dirt -->
			
			<!-- foul / running lines -->
			<a-box n-mesh-collider="type:hologram" color="yellow" position="37, 1.1, 5" rotation="0 45 0" scale="1 1 12"></a-box>
			<a-box n-mesh-collider="type:hologram" color="yellow" position="47, 1.1, 5" rotation="0 135 0" scale="1 1 12"></a-box> 
			<a-box n-mesh-collider="type:hologram" color="yellow" position="37, 1.1, -5" rotation="0 135 0" scale="1 1 12"></a-box>
			<a-box n-mesh-collider="type:hologram" color="yellow" position="47, 1.1, -5" rotation="0 45 0" scale="1 1 12"></a-box>
			<a-box n-mesh-collider="type:hologram" color="yellow" position="49, 1.1, -17" rotation="0 135 0" scale="1 1 18"></a-box>
			<a-box n-mesh-collider="type:hologram" color="yellow" position="49, 1.1, 17" rotation="0 45 0" scale="1 1 18"></a-box>
			<!-- --- -->

			<a-cylinder color="#c48f70" height="1" radius="1" position="38 1.1 0"></a-cylinder> <!-- pitchers stump -->
			
			<a-cylinder color="#c48f70" height="1" radius="2" position="52 1.01 0"></a-cylinder> <!-- base2 dirt -->
			<a-cylinder color="#c48f70" height="1" radius="2" position="42 1.01 10"></a-cylinder> <!-- base1 dirt -->
			<a-cylinder color="#c48f70" height="1" radius="2" position="42 1.01 -10"></a-cylinder> <!-- base3 dirt -->
			
			<a-box n-mesh-collider="type:hologram" color="white" position="42, 1.1, 10" rotation="0 45 0" scale="1 1 1"></a-box> <!-- base1 -->
			<a-box n-mesh-collider="type:hologram" color="white" position="52, 1.1, 0" rotation="0 45 0" scale="1 1 1"></a-box> <!-- base2 -->
			<a-box n-mesh-collider="type:hologram" color="white" position="42, 1.1, -10" rotation="0 45 0" scale="1 1 1"></a-box> <!-- base3 -->
			
			 
			<a-box id="home_collider" n-box-collider="isTrigger: true" n-container="capacity: 1" base_collision="box_id:0;"n-mesh-collider="type:hologram" color="white" position="32, 3, 0" rotation="0 0 0" scale="2 3 2" opacity="0.5"  altspace-cursor-collider="enabled: false"></a-box> <!-- home collider-->
			<a-box id="base1_collider" n-box-colliser="isTrigger: true" n-container="capacity: 1" base_collision="box_id:1;" n-mesh-collider="type:hologram" color="white" position="42, 3, 10" rotation="0 45 0" scale="2 3 2" opacity="0.5" altspace-cursor-collider="enabled: false"></a-box> <!-- base1 collider -->
			<a-box id="base2_collider" n-box-collider="isTrigger: true" n-container="capacity: 1" base_collision="box_id:2;" n-mesh-collider="type:hologram" color="white" position="52, 3, 0" rotation="0 45 0" scale="2 3 2" opacity="0.5" altspace-cursor-collider="enabled: false"></a-box> <!-- base2 collider -->
			<a-box id="base3_collider" n-box-collider="isTrigger: true" n-container="capacity: 1" base_collision="box_id:3;" n-mesh-collider="type:hologram" color="white" position="42, 3, -10" rotation="0 45 0" scale="2 3 2" opacity="0.5"  altspace-cursor-collider="enabled: false"></a-box> <!-- base3 collider -->
      
		<!-- borders -->
		<a-entity class="outside_walls" scale="1 1 1">
			<a-box n-mesh-collider="type:environment" color="grey" position="6, 1, 0" rotation="0 0 0" scale="1 1 30"></a-box>
			<a-box n-mesh-collider="type:environment" color="grey" position="11, 1, -20" rotation="0 -45 0" scale="1 1 14.142"></a-box>
			<a-box n-mesh-collider="type:environment" color="yellow" position="31, 1, -25" rotation="0 90 0" scale="1 1 30"></a-box>
		</a-entity>
		
		  <!-- homerun fireworks -->
      <a-entity id="hr_firework" position="32 1 0" n-object='res: effects/fireworks' begin='HR'></a-entity>
   
		<a-box id="homerun1" scale="1 1 1" color="red" position="36 2 0">
			<a-animation attribute="rotation" dur="1500" to="0 360 0" begin="homeRun" easing="ease" repeat="0" sync sync-transform></a-animation>
		</a-box>
	<!--https://video-jukebox.firebaseapp.com/-->
	

</a-scene>
 
 
</body>

<script>

//move document so baseball does not collide
altspace.getDocument().then(function (document) { document.position.set(-50000, -50000, -50000); document.scale.set(0.001, 0.001, 0.001)});

//init vars
var scene = document.querySelector('a-scene');
var base1 = document.createElement('a-box');
var base2 = document.createElement('a-box');
var base3 = document.createElement('a-box');

//set attributes
base1.setAttribute('scale', '3 3 3');
base1.setAttribute('color','#FF00FF');
base1.setAttribute('position', '95 28 11');

base2.setAttribute('scale', '3 3 3');
base2.setAttribute('color','#FF00FF');
base2.setAttribute('position', '95 40 0');

base3.setAttribute('scale', '3 3 3');
base3.setAttribute('color','#FF00FF');
base3.setAttribute('position', '95 28 -11');

//add to scene
scene.appendChild(base1);
scene.appendChild(base2);
scene.appendChild(base3);

AFRAME.registerComponent('base_collision',
                         {
  schema: 
  { 
    jointCubeSize: {
      type: 'float',
      default: 0.275
    },
	box_id:
	{
		type: 'int'
	}
  },

  init: function ()
  {
    var self = this;
    var object = self.el.object3D;
	
	var last_base = 0;

    object.addBehavior(new altspace.utilities.behaviors.JointCollisionEvents
                       ({

      joints: [['Head', 'Center', 0]], jointCubeSize: self.data.jointCubeSize

    }));

    object.addEventListener('jointcollisionenter', handleJoin);		
    function handleJoin(event)
    {
	    
	    	console.log(last_base);
		console.log();
	    
		if(self.data.box_id == 1){
			base1.setAttribute('color', '#FFFF00');
			console.log("base 1 touched");
			if (last_base == 0){
				console.log("first base");
				last_base = 1;
			}
		}
		else if(self.data.box_id == 2){
			base2.setAttribute('color', '#FFFF00');
			console.log("base 2 touched");
			if (last_base == 1){
				console.log("second base");
				last_base = 2;
			}
		}
		else if(self.data.box_id == 3){
			base3.setAttribute('color', '#FFFF00');
			console.log("base 3 touched");
			if (last_base == 2){
				console.log("third base");
				last_base = 3;
			}
		}
		
		if(self.data.box_id == 0){
			console.log("home base touched");
			if (last_base == 3){
				console.log("home run");
				last_base = 0;
				document.querySelector('#homerun1').emit('homeRun');
			}
		}
    }// end function handle join


    object.addEventListener('jointcollisionleave', handleLeave);
    function handleLeave(event)
    {
			base1.setAttribute('color', '#FFFFFF');
			base2.setAttribute('color', '#FFFFFF');
			base3.setAttribute('color', '#FFFFFF');
	    
	    
	
    }//end function handle leave
  }
});




</script>


</html>
